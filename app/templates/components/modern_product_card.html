<!-- Modern Product Card Component -->
<!-- Usage: {% include 'components/modern_product_card.html' with context %} -->
<!-- Required variables: purchase, show_user (optional), card_type (optional: 'grid', 'list', 'feed') -->

{% set card_type = card_type or 'grid' %}
{% set show_user = show_user or false %}
{% set user_has_liked = current_user and purchase.interactions.filter_by(user_id=current_user.id, type='like').first() %}
{% set user_has_saved = current_user and purchase.interactions.filter_by(user_id=current_user.id, type='save').first() %}
{% set like_count = purchase.interactions.filter_by(type='like').count() %}
{% set comment_count = purchase.interactions.filter_by(type='comment').count() %}
{% set can_share = current_user and current_user.id == purchase.user_id %}
{% set is_shared = purchase.is_shared %}

<article class="product-card card" 
         style="padding: 0; overflow: hidden; transition: all var(--transition-base);"
         data-purchase-id="{{ purchase.id }}"
         data-store="{{ purchase.store_name }}" 
         data-sharing="{{ 'shared' if purchase.is_shared else 'private' }}"
         data-date="{{ purchase.purchase_date.isoformat() }}"
         data-price="{{ purchase.product.price }}"
         data-category="{{ purchase.product.category or '' }}">
    
    {% if card_type == 'list' %}
        <!-- List Layout -->
        <div style="display: flex; align-items: center; padding: var(--space-4);">
            <!-- Product Image -->
            <div style="width: 80px; height: 80px; flex-shrink: 0; margin-right: var(--space-4); position: relative;">
                <img src="{{ purchase.product.image_url or url_for('static', filename='images/placeholder-product.svg') }}" 
                     alt="{{ purchase.product.title }}" 
                     style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-lg);"
                     loading="lazy">
                
                <!-- Sharing Status Badge -->
                <div style="position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-size: 10px; {{ 'background: var(--color-success); color: var(--color-white);' if is_shared else 'background: var(--color-gray-400); color: var(--color-white);' }}">
                    <i class="fas {{ 'fa-share-alt' if is_shared else 'fa-lock' }}"></i>
                </div>
            </div>
            
            <!-- Product Info -->
            <div style="flex: 1; min-width: 0;">
                <h3 style="font-size: var(--text-lg); font-weight: var(--font-semibold); margin-bottom: var(--space-1); color: var(--color-gray-900); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    {{ purchase.product.title }}
                </h3>
                <p style="font-size: var(--text-sm); color: var(--color-gray-600); margin-bottom: var(--space-2);">
                    {{ purchase.store_name }} â€¢ {{ purchase.purchase_date.strftime('%b %d, %Y') }}
                </p>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--color-gray-900);">
                        ${{ "%.2f"|format(purchase.product.price) }}
                    </span>
                    
                    {% if show_user %}
                    <div style="display: flex; align-items: center; gap: var(--space-3);">
                        <!-- Like Button -->
                        <button class="like-button" 
                                data-purchase-id="{{ purchase.id }}"
                                style="background: none; border: none; cursor: pointer; color: {{ 'var(--color-error)' if user_has_liked else 'var(--color-gray-400)' }}; transition: color var(--transition-fast);">
                            <i class="{{ 'fas' if user_has_liked else 'far' }} fa-heart"></i>
                            <span style="font-size: var(--text-xs); margin-left: var(--space-1);">{{ like_count }}</span>
                        </button>
                        
                        <!-- Save Button -->
                        <button class="save-button" 
                                data-purchase-id="{{ purchase.id }}"
                                style="background: none; border: none; cursor: pointer; color: {{ 'var(--color-warning)' if user_has_saved else 'var(--color-gray-400)' }}; transition: color var(--transition-fast);">
                            <i class="{{ 'fas' if user_has_saved else 'far' }} fa-bookmark"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
    {% else %}
        <!-- Grid Layout (Default) -->
        <div style="position: relative;">
            <!-- Product Image -->
            <div style="position: relative; height: 200px; overflow: hidden;">
                <img src="{{ purchase.product.image_url or url_for('static', filename='images/placeholder-product.svg') }}" 
                     alt="{{ purchase.product.title }}" 
                     style="width: 100%; height: 100%; object-fit: cover; transition: transform var(--transition-base);"
                     loading="lazy"
                     onmouseover="this.style.transform='scale(1.05)'"
                     onmouseout="this.style.transform='scale(1)'">
                
                <!-- Sharing Status Badge -->
                <div style="position: absolute; top: var(--space-3); right: var(--space-3); padding: var(--space-1) var(--space-2); border-radius: var(--radius-full); font-size: var(--text-xs); font-weight: var(--font-medium); {{ 'background: var(--color-success); color: var(--color-white);' if is_shared else 'background: var(--color-gray-600); color: var(--color-white);' }}">
                    <i class="fas {{ 'fa-share-alt' if is_shared else 'fa-lock' }} mr-1"></i>
                    {{ 'Shared' if is_shared else 'Private' }}
                </div>
                
                <!-- Category Badge -->
                {% if purchase.product.category %}
                <div style="position: absolute; top: var(--space-3); left: var(--space-3); padding: var(--space-1) var(--space-2); background: rgba(255, 255, 255, 0.9); border-radius: var(--radius-lg); font-size: var(--text-xs); font-weight: var(--font-medium); color: var(--color-gray-700);">
                    {{ purchase.product.category }}
                </div>
                {% endif %}
                
                <!-- Quick Actions Overlay -->
                {% if show_user %}
                <div style="position: absolute; bottom: var(--space-3); right: var(--space-3); display: flex; gap: var(--space-2); opacity: 0; transition: opacity var(--transition-base);" class="quick-actions">
                    <!-- Like Button -->
                    <button class="like-button" 
                            data-purchase-id="{{ purchase.id }}"
                            style="width: 36px; height: 36px; border-radius: var(--radius-full); background: rgba(255, 255, 255, 0.9); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: {{ 'var(--color-error)' if user_has_liked else 'var(--color-gray-600)' }}; transition: all var(--transition-fast);">
                        <i class="{{ 'fas' if user_has_liked else 'far' }} fa-heart"></i>
                    </button>
                    
                    <!-- Save Button -->
                    <button class="save-button" 
                            data-purchase-id="{{ purchase.id }}"
                            style="width: 36px; height: 36px; border-radius: var(--radius-full); background: rgba(255, 255, 255, 0.9); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: {{ 'var(--color-warning)' if user_has_saved else 'var(--color-gray-600)' }}; transition: all var(--transition-fast);">
                        <i class="{{ 'fas' if user_has_saved else 'far' }} fa-bookmark"></i>
                    </button>
                </div>
                {% endif %}
            </div>
            
            <!-- Product Details -->
            <div style="padding: var(--space-4);">
                <!-- User Info (if showing user) -->
                {% if show_user and purchase.user %}
                <div style="display: flex; align-items: center; margin-bottom: var(--space-3);">
                    <img src="{{ url_for('static', filename='images/profile/' + (purchase.user.profile_image or 'default.jpg')) }}" 
                         alt="{{ purchase.user.name }}" 
                         style="width: 32px; height: 32px; border-radius: var(--radius-full); object-fit: cover; margin-right: var(--space-2);">
                    <div>
                        <p style="font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--color-gray-900); margin: 0;">{{ purchase.user.name }}</p>
                        <p style="font-size: var(--text-xs); color: var(--color-gray-500); margin: 0;">{{ purchase.purchase_date.strftime('%b %d, %Y') }}</p>
                    </div>
                </div>
                {% endif %}
                
                <!-- Product Title -->
                <h3 style="font-size: var(--text-lg); font-weight: var(--font-semibold); margin-bottom: var(--space-2); color: var(--color-gray-900); line-height: var(--leading-tight); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                    {{ purchase.product.title }}
                </h3>
                
                <!-- Store and Date (if not showing user) -->
                {% if not show_user %}
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);">
                    <p style="font-size: var(--text-sm); color: var(--color-gray-600); margin: 0;">{{ purchase.store_name }}</p>
                    <p style="font-size: var(--text-sm); color: var(--color-gray-500); margin: 0;">{{ purchase.purchase_date.strftime('%b %d, %Y') }}</p>
                </div>
                {% endif %}
                
                <!-- Price -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                    <span style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--color-gray-900);">
                        ${{ "%.2f"|format(purchase.product.price) }}
                    </span>
                    
                    {% if show_user %}
                    <div style="display: flex; align-items: center; gap: var(--space-4);">
                        <div style="display: flex; align-items: center; color: var(--color-gray-500);">
                            <i class="far fa-heart mr-1"></i>
                            <span style="font-size: var(--text-sm);">{{ like_count }}</span>
                        </div>
                        <div style="display: flex; align-items: center; color: var(--color-gray-500);">
                            <i class="far fa-comment mr-1"></i>
                            <span style="font-size: var(--text-sm);">{{ comment_count }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Share Comment -->
                {% if purchase.share_comment %}
                <div style="background: var(--color-gray-50); padding: var(--space-3); border-radius: var(--radius-lg); margin-bottom: var(--space-4); border-left: 3px solid var(--color-primary-500);">
                    <p style="font-size: var(--text-sm); color: var(--color-gray-700); margin: 0; font-style: italic; line-height: var(--leading-relaxed);">
                        "{{ purchase.share_comment }}"
                    </p>
                </div>
                {% endif %}
                
                <!-- Actions -->
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <!-- Sharing Toggle (only for purchase owner) -->
                    {% if can_share %}
                    <div style="display: flex; align-items: center;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" 
                                   class="sharing-toggle" 
                                   data-purchase-id="{{ purchase.id }}"
                                   {{ 'checked' if purchase.is_shared else '' }}
                                   style="margin-right: var(--space-2);">
                            <span style="font-size: var(--text-sm); color: var(--color-gray-600);">
                                {{ 'Shared' if purchase.is_shared else 'Share' }}
                            </span>
                        </label>
                    </div>
                    {% else %}
                    <div style="display: flex; align-items: center;">
                        <span style="font-size: var(--text-sm); color: var(--color-gray-500); font-style: italic;">
                            {% if purchase.is_shared %}
                                <i class="fas fa-share-alt mr-1" style="color: var(--color-success);"></i>Shared by {{ purchase.user.name }}
                            {% else %}
                                <i class="fas fa-lock mr-1"></i>Private
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                    
                    <!-- View Details Button -->
                    <button onclick="viewProductDetails({{ purchase.id }})" 
                            class="btn btn-sm btn-outline"
                            style="font-size: var(--text-sm);">
                        <i class="fas fa-external-link-alt mr-1"></i>
                        View Details
                    </button>
                </div>
            </div>
        </div>
    {% endif %}
</article>

<style>
.product-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.product-card:hover .quick-actions {
    opacity: 1;
}

.like-button:hover {
    color: var(--color-error) !important;
    transform: scale(1.1);
}

.save-button:hover {
    color: var(--color-warning) !important;
    transform: scale(1.1);
}
</style>